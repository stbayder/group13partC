{% extends "base.html" %}
{% block title %}Add Product{% endblock %}
{% block content %}

<div class="contact-container">
    <!-- Buttons to choose action -->
    <div id="create-or-add">
        <h1>砖  爪专 砖 爪专 砖 住驻拽</h1>
        <p>砖 专  爪专 砖 爪专 砖 砖专  拽 拽, <br>
         砖 爪专 拽 住驻拽.</p>
        <div class="create-or-add-btn-container">
            <button id="create-btn">爪专 爪专 砖</button>
            <button id="add-btn">砖 爪专 拽</button>
        </div>    
    </div>

    <!-- Add New Product Form -->
    <div id="add-new-product" class="form-container disabled">
        <h1>住驻转 爪专 砖</h1>
        <form id="addProductForm" onsubmit="createAnewProduct(event)" enctype="multipart/form-data">
            <div class="form-group">
                <label for="product_name">砖 爪专:</label>
                <input type="text" id="product_name" name="product_name" required>
                <div class="error" id="product_name-error">  砖 爪专</div>
            </div>
            <div class="form-group">
                <label for="product_category_select">拽专:</label>
                <select id="product_category_select" name="product_category_select" required>
                    <option value=""> </option>
                    <option value="拽专拽">拽专拽 </option>
                    <option value="专">专 </option>
                    <option value=""> </option>
                    <option value="爪注爪注">爪注爪注 Ц</option>
                    <option value="住驻专">住驻专 </option>
                    <option value="拽住拽">拽住拽 </option>
                    <option value="专">专 </option>
                </select>
            </div>
            <div class="form-group">
                <label for="product_description">转专:</label>
                <textarea id="product_description" name="description" required></textarea>
                <div class="error" id="description-error">  转专 爪专 (' 10 转)</div>
            </div>
            <div class="form-group">
                <label for="product_image">转:</label>
                <input type="text" id="product_image" name="product_image" required>
                <div class="error" id="image-error"> 专 拽抓 转</div>
            </div>
            <div class="form-group">
                <label for="product_price1"> 专 转 专砖:</label>
                <input type="number" id="product_price1" name="price1" step="0.01" required>
                <div class="error" id="price1-error">  专 转拽</div>
            </div>
            <div class="form-group">
                <label for="product_amount1"> 转 驻专 专 专砖:</label>
                <input type="number" id="product_amount1" name="amount1" step="0.01" required>
                <div class="error" id="amount1-error">  转 转拽</div>
            </div>
             <div class="form-group">
                <label for="product_price2"> 专 转 砖:</label>
                <input type="number" id="product_price2" name="price2" step="0.01" required>
                <div class="error" id="price2-error">  专 转拽</div>
            </div>
            <div class="form-group">
                <label for="product_amount_2">转 砖:</label>
                <input type="number" id="product_amount2" name="amount2" step="0.01" required>
                <div class="error" id="amount2-error">  转 转拽</div>
            </div>
            <div class="form-group">
                <label for="product_units"> 转 转 </label>
                <input type="number" id="product_units" name="units" required>
                <div class="error" id="units-error">  转 转 转拽</div>
            </div>
            <div id="supplier-container"></div>
            <button type="submit">住祝 爪专</button>
        </form>
        <div class="success-message" id="success-message">爪专 住祝 爪!</div>
    </div> 
    
    <!-- Link Existing Product Form -->
    <div id="link-existing-product" class="form-container disabled">
        <h1>砖 爪专 拽 住驻拽</h1>
        <form id="linkProductForm" method="POST" action="/link-product">
            <div class="form-group">
                <label for="existing_product_id"> 爪专:</label>
                <input type="text" id="existing_product_id" name="existing_product_id" required>
                <div class="error" id="existing_product_id-error">   爪专 转拽</div>
            </div>
            <div id="supplier-container"></div>
            <button type="submit">砖 爪专</button>
        </form>
    </div> 
</div>

<script>
let userData = null;
document.addEventListener("DOMContentLoaded", async () => {
    userData = await getUserData();
    if (userData.Role === "Supplier" || userData.Role === "Admin") {
        showAddButtons();
        setupButtonHandlers(userData.Role);
    } else {
        alert('专拽 住驻拽   爪注 驻注 .');
        window.location.href = "/login";
    }
});

function showAddButtons() {
    document.getElementById("create-or-add").classList.remove("disabled");
}

function setupButtonHandlers(role) {
    document.getElementById("create-btn").addEventListener("click", () => {
        showForm("add-new-product");
        if (role == "Admin") {
            addSupplierDropdown();
        }
    });
    document.getElementById("add-btn").addEventListener("click", () => {
        showForm("link-existing-product");
    });
}

function showForm(formId) {
    document.querySelectorAll(".form-container").forEach(form => form.classList.add("disabled"));
    document.getElementById(formId).classList.remove("disabled");
}

async function addSupplierDropdown() {
    try {
        const response = await fetch("/suppliers");
        let suppliers = await response.json();
        suppliers = suppliers.data
        let supplierDropdown = `<div class="form-group">
                <label for="supplier_select">专 住驻拽:</label>
                <select id="supplier_select" name="supplier_name" required>
                    ${suppliers.map(supplier => `<option value="${supplier.SuppName}">${supplier.SuppName}</option>`).join("")}
                </select>
            </div>`;
        document.getElementById("supplier-container").innerHTML = supplierDropdown;
    } catch (error) {
        console.error("Error fetching suppliers:", error);
    }
}

async function getSupplier() {
    let SupplierToGet = userData.Role === 'Supplier' ? userData.UserName : document.getElementById('supplier_select').value;
    try {
        const response = await fetch(`/supplier/by-name/${SupplierToGet}`);
        if (!response.ok) throw new Error("Failed to fetch supplier");
        return await response.json();
    } catch (error) {
        console.error("Error fetching supplier:", error);
        return null;
    }
}

async function createAnewProduct(event) {
    event.preventDefault();

    try {
        let Supplier = await getSupplier();
        // Ensure Supplier is fully loaded before proceeding
        if (!Supplier.data.SuppName) {
            alert("砖:  爪 住驻拽.");
            return;
        }

        let product = {
            "SupplierName": Supplier.data.SuppName,  // Ensured SupplierName is set
            "ProdName": document.getElementById('product_name').value,
            "Category": document.getElementById('product_category_select').value,
            "Specifications": document.getElementById('product_description').value,
            "Img": document.getElementById('product_image').value,
            "StockQuantity": parseInt(document.getElementById('product_units').value, 10),
            "Currency": "ILS",
            "Price1": parseFloat(document.getElementById('product_price1').value),
            "Amount1": parseInt(document.getElementById('product_amount1').value, 10),
            "Price2": parseFloat(document.getElementById('product_price2').value),
            "Amount2": parseInt(document.getElementById('product_amount2').value, 10)
        };

        const response = await fetch('/add-product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product),
        });

        const data = await response.json();
        if (response.ok) {
            alert("爪专 住祝 爪!");
            document.getElementById("addProductForm").reset();
        } else {
            console.error("Error:", data.error);
            alert("砖 住驻转 爪专: " + data.error);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("砖 注转 砖转 转 砖专转.");
    }
}


</script>

<style>
.disabled {
    display: none;  
}

#create-or-add {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 1rem;
}

#create-or-add h1 {
    margin-bottom: 1rem;
}

.create-or-add-btn-container {
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap:1rem;
}

button {
    width: 10vw;
    padding: 1rem;
}

#add-btn {
    background-color: #5A8FBA;
}

#create-btn {
    background-color: #9AA6B2;
}
</style>
{% endblock %}

